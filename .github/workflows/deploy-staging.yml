name: Deploy Staging

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: stage
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - run: pnpm install

      # Run functional + workers tests (no real AWS calls)
      - name: Run Tests
        run: pnpm --filter=@sabaipics/api test:run

      # TODO: Future improvement - run migrations on a test branch first, verify, then merge to main DB
      # Currently runs migrations directly which is risky for production
      - name: Run Database Migrations
        run: pnpm --filter=@sabaipics/db db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Create dashboard env file for staging
      - name: Create Dashboard Env
        run: |
          echo "VITE_API_URL=https://api-staging.sabaipics.com" >> apps/dashboard/.env.staging
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}" >> apps/dashboard/.env.staging

      - run: pnpm build

      # Deploy API to Cloudflare Workers
      - name: Deploy API
        run: pnpm --filter=@sabaipics/api deploy:staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Set API secrets
      - name: Set API Secrets
        working-directory: apps/api
        run: |
          echo "${{ secrets.DATABASE_URL }}" | pnpm wrangler secret put DATABASE_URL --env staging
          echo "${{ secrets.CLERK_SECRET_KEY }}" | pnpm wrangler secret put CLERK_SECRET_KEY --env staging
          echo "${{ secrets.CLERK_PUBLISHABLE_KEY }}" | pnpm wrangler secret put CLERK_PUBLISHABLE_KEY --env staging
          echo "${{ secrets.CLERK_JWT_KEY }}" | pnpm wrangler secret put CLERK_JWT_KEY --env staging
          echo "${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}" | pnpm wrangler secret put CLERK_WEBHOOK_SIGNING_SECRET --env staging
          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | pnpm wrangler secret put AWS_ACCESS_KEY_ID --env staging
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | pnpm wrangler secret put AWS_SECRET_ACCESS_KEY --env staging
          echo "${{ secrets.AWS_REGION }}" | pnpm wrangler secret put AWS_REGION --env staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Deploy Dashboard to Cloudflare Pages
      - name: Deploy Dashboard
        run: pnpm --filter=@sabaipics/dashboard deploy:staging
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
