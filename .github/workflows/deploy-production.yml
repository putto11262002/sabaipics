name: Deploy Production

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - run: pnpm install

      - name: Validate Required Secrets
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_JWT_KEY: ${{ secrets.CLERK_JWT_KEY }}
          CLERK_WEBHOOK_SIGNING_SECRET: ${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: |
          set -euo pipefail
          required=(
            DATABASE_URL
            CLERK_SECRET_KEY
            CLERK_PUBLISHABLE_KEY
            CLERK_JWT_KEY
            CLERK_WEBHOOK_SIGNING_SECRET
            AWS_ACCESS_KEY_ID
            AWS_SECRET_ACCESS_KEY
            STRIPE_SECRET_KEY
            STRIPE_WEBHOOK_SECRET
            R2_ACCESS_KEY_ID
            R2_SECRET_ACCESS_KEY
            ADMIN_API_KEY
          )
          # LINE secrets are optional until LINE integration is enabled
          optional=(
            LINE_CHANNEL_SECRET
            LINE_CHANNEL_ACCESS_TOKEN
          )

          for k in "${required[@]}"; do
            v="${!k:-}"
            if [[ -z "$v" ]]; then
              echo "Missing required secret: $k" >&2
              exit 1
            fi
          done

          for k in "${optional[@]}"; do
            v="${!k:-}"
            if [[ -z "$v" ]]; then
              echo "::warning::Optional secret not set: $k (LINE integration disabled)"
            fi
          done

      # Run unit tests (no real API calls)
      - name: Run Tests
        run: pnpm --filter=@sabaipics/api test:run
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}
          CLERK_PUBLISHABLE_KEY: ${{ secrets.CLERK_PUBLISHABLE_KEY }}
          CLERK_JWT_KEY: ${{ secrets.CLERK_JWT_KEY }}
          CLERK_WEBHOOK_SIGNING_SECRET: ${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-west-2
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          # Optional LINE secrets - tests should handle missing values gracefully
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}

      # NOTE: Integration tests (test:integration) are excluded from CI/CD
      # They make real API calls to AWS/Stripe and should only be run locally

      # TODO: Future improvement - run migrations on a test branch first, verify, then merge to main DB
      # Currently runs migrations directly which is risky for production
      - name: Run Database Migrations
        run: pnpm --filter=@sabaipics/db db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Create dashboard env file for production
      - name: Create Dashboard Env
        run: |
          echo "VITE_API_URL=https://api.sabaipics.com" > apps/dashboard/.env.production
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}" >> apps/dashboard/.env.production

      - run: pnpm build

      # Deploy API to Cloudflare Workers
      - name: Deploy API
        run: pnpm --filter=@sabaipics/api deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Set API secrets
      - name: Set API Secrets
        working-directory: apps/api
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
          LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        run: |
          echo "${{ secrets.DATABASE_URL }}" | pnpm wrangler secret put DATABASE_URL --env production
          echo "${{ secrets.CLERK_SECRET_KEY }}" | pnpm wrangler secret put CLERK_SECRET_KEY --env production
          echo "${{ secrets.CLERK_PUBLISHABLE_KEY }}" | pnpm wrangler secret put CLERK_PUBLISHABLE_KEY --env production
          echo "${{ secrets.CLERK_JWT_KEY }}" | pnpm wrangler secret put CLERK_JWT_KEY --env production
          echo "${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}" | pnpm wrangler secret put CLERK_WEBHOOK_SIGNING_SECRET --env production
          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | pnpm wrangler secret put AWS_ACCESS_KEY_ID --env production
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | pnpm wrangler secret put AWS_SECRET_ACCESS_KEY --env production
          echo "${{ secrets.STRIPE_SECRET_KEY }}" | pnpm wrangler secret put STRIPE_SECRET_KEY --env production
          echo "${{ secrets.STRIPE_WEBHOOK_SECRET }}" | pnpm wrangler secret put STRIPE_WEBHOOK_SECRET --env production
          echo "${{ secrets.R2_ACCESS_KEY_ID }}" | pnpm wrangler secret put R2_ACCESS_KEY_ID --env production
          echo "${{ secrets.R2_SECRET_ACCESS_KEY }}" | pnpm wrangler secret put R2_SECRET_ACCESS_KEY --env production
          echo "${{ secrets.ADMIN_API_KEY }}" | pnpm wrangler secret put ADMIN_API_KEY --env production
          # Optional LINE secrets
          if [[ -n "$LINE_CHANNEL_SECRET" ]]; then
            echo "$LINE_CHANNEL_SECRET" | pnpm wrangler secret put LINE_CHANNEL_SECRET --env production
          fi
          if [[ -n "$LINE_CHANNEL_ACCESS_TOKEN" ]]; then
            echo "$LINE_CHANNEL_ACCESS_TOKEN" | pnpm wrangler secret put LINE_CHANNEL_ACCESS_TOKEN --env production
          fi

      # Deploy Dashboard to Cloudflare Pages
      - name: Deploy Dashboard
        run: pnpm --filter=@sabaipics/dashboard deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
