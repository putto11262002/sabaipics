name: Deploy Production

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - run: pnpm install

      # Run functional + workers tests (no real AWS calls)
      - name: Run Tests
        run: pnpm --filter=@sabaipics/api test:run

      # Run integration tests with real AWS (validates Rekognition connectivity)
      - name: Run Integration Tests
        run: pnpm --filter=@sabaipics/api test:integration
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      # TODO: Future improvement - run migrations on a test branch first, verify, then merge to main DB
      # Currently runs migrations directly which is risky for production
      - name: Run Database Migrations
        run: pnpm --filter=@sabaipics/db db:migrate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      # Create dashboard env file for production
      - name: Create Dashboard Env
        run: |
          echo "VITE_API_URL=https://api.sabaipics.com" >> apps/dashboard/.env.production
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}" >> apps/dashboard/.env.production

      - run: pnpm build

      # Deploy API to Cloudflare Workers
      - name: Deploy API
        run: pnpm --filter=@sabaipics/api deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Set API secrets
      - name: Set API Secrets
        working-directory: apps/api
        run: |
          echo "${{ secrets.DATABASE_URL }}" | pnpm wrangler secret put DATABASE_URL --env production
          echo "${{ secrets.CLERK_SECRET_KEY }}" | pnpm wrangler secret put CLERK_SECRET_KEY --env production
          echo "${{ secrets.CLERK_PUBLISHABLE_KEY }}" | pnpm wrangler secret put CLERK_PUBLISHABLE_KEY --env production
          echo "${{ secrets.CLERK_JWT_KEY }}" | pnpm wrangler secret put CLERK_JWT_KEY --env production
          echo "${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}" | pnpm wrangler secret put CLERK_WEBHOOK_SIGNING_SECRET --env production
          echo "${{ secrets.AWS_ACCESS_KEY_ID }}" | pnpm wrangler secret put AWS_ACCESS_KEY_ID --env production
          echo "${{ secrets.AWS_SECRET_ACCESS_KEY }}" | pnpm wrangler secret put AWS_SECRET_ACCESS_KEY --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Deploy Dashboard to Cloudflare Pages
      - name: Deploy Dashboard
        run: pnpm --filter=@sabaipics/dashboard deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
