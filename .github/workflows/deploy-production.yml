name: Deploy Production

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        with:
          version: 9.0.0

      - run: pnpm install

      # Create dashboard env file for production
      - name: Create Dashboard Env
        run: |
          echo "VITE_API_URL=https://api.sabaipics.com" >> apps/dashboard/.env.production
          echo "VITE_CLERK_PUBLISHABLE_KEY=${{ secrets.CLERK_PUBLISHABLE_KEY }}" >> apps/dashboard/.env.production

      - run: pnpm build

      # Deploy API to Cloudflare Workers
      - name: Deploy API
        run: pnpm --filter=@sabaipics/api deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Set API secrets
      - name: Set API Secrets
        working-directory: apps/api
        run: |
          echo "${{ secrets.DATABASE_URL }}" | pnpm wrangler secret put DATABASE_URL --env production
          echo "${{ secrets.CLERK_SECRET_KEY }}" | pnpm wrangler secret put CLERK_SECRET_KEY --env production
          echo "${{ secrets.CLERK_PUBLISHABLE_KEY }}" | pnpm wrangler secret put CLERK_PUBLISHABLE_KEY --env production
          echo "${{ secrets.CLERK_JWT_KEY }}" | pnpm wrangler secret put CLERK_JWT_KEY --env production
          echo "${{ secrets.CLERK_WEBHOOK_SIGNING_SECRET }}" | pnpm wrangler secret put CLERK_WEBHOOK_SIGNING_SECRET --env production
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      # Deploy Dashboard to Cloudflare Pages
      - name: Deploy Dashboard
        run: pnpm --filter=@sabaipics/dashboard deploy:prod
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
