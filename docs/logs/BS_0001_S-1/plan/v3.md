# Execution Plan (P)

Execution root: `BS_0001_S-1`
Upstream (PM): slice `d999677d-0b51-4b3b-b163-eec36a5bdde3` (S-1: Photographer Onboarding & Photo Upload)
Date: `2026-01-09`
Owner: Tech Lead (AI-assisted)

## Inputs

- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
- Context reports: `docs/logs/BS_0001_S-1/context/*.md`
- Research: `docs/logs/BS_0001_S-1/research/*.md`
- Decisions: `docs/logs/BS_0001_S-1/decisions-input.md`

---

## Decisions Applied (v1 → v2 → v3)

| #   | Decision               | Resolution                                                      | Source |
| --- | ---------------------- | --------------------------------------------------------------- | ------ |
| 1   | Session timeout        | **24 hours**                                                    | v2     |
| 2   | HEIC/RAW handling      | **Support & convert via CF Images** (on-demand, not stored)     | v2     |
| 3   | Credit packages        | **Store in DB** (admin-editable)                                | v2     |
| 4   | User type verification | **Not needed** — only photographers sign up                     | v2     |
| 5   | Thumbnails             | **On-demand via CF Images URL** (400px grid / 1200px preview)   | v2     |
| 6   | Face-aware cropping    | **Out of scope**                                                | v2     |
| 7   | QR codes               | **Eager generation** on event create                            | v2     |
| 8   | PromptPay              | **Enabled** for Thai market                                     | v2     |
| 9   | Credit expiration      | **6 months** from purchase date                                 | v2     |
| 10  | Clerk email            | **Required** — Clerk prompts if LINE doesn't provide            | v3     |
| 11  | Credit packages UI     | **Dedicated page** (`/credits/packages`) not modal              | v3     |
| 12  | Rekognition collection | **Create on first upload** (not event create)                   | v3     |
| 13  | QR URLs                | **Two separate URLs**: search + slideshow                       | v3     |
| 14  | Credit deduction       | **After validation success**, no refund on later failures       | v3     |
| 15  | Data retention         | **30 days after event created**, delete originals + Rekognition | v3     |
| 16  | Storage strategy       | **Only store original**, no JPEG (CF Images on-demand)          | v3     |

---

## Architecture Overview

### Storage Strategy (Simplified)

```
┌─────────────────────────────────────────────────────────────────┐
│                         R2 Bucket                               │
│  └─ events/{eventId}/photos/{photoId}/original.{ext}           │
│     (HEIC, RAW, JPEG, PNG, WebP — whatever user uploads)       │
└─────────────────────────────────────────────────────────────────┘
                              │
           ┌──────────────────┼──────────────────┐
           ▼                  ▼                  ▼
    ┌─────────────┐   ┌──────────────┐   ┌──────────────┐
    │ Web Display │   │  Rekognition │   │   Download   │
    │ (on-demand) │   │  (one-time)  │   │  (original)  │
    └─────────────┘   └──────────────┘   └──────────────┘
           │                  │                  │
    CF Images URL      CF Images fetch     Direct R2 URL
    width=400/1200     → JPEG bytes        (presigned)
    format=auto        → IndexFaces
    (CDN cached)       (not stored)
```

**Key points:**

- Only ONE file stored per photo (original)
- CF Images handles all format conversion on-demand
- High CDN cache hit rate (Thai users)
- Rekognition receives JPEG bytes in memory (not stored)

### Credit Deduction Flow

```
Upload Request
     │
     ▼
┌─────────────┐
│ Validation  │ ◄── Format, size, auth checks
└─────────────┘
     │
     ├── FAIL → 400 error, NO credit deduction
     │
     ▼ PASS
┌─────────────┐
│ Deduct 1    │ ◄── Credit charged HERE
│ Credit      │
└─────────────┘
     │
     ▼
┌─────────────┐
│ Upload to   │
│ R2          │
└─────────────┘
     │
     ├── FAIL → Credit already charged, NO refund
     │
     ▼ PASS
┌─────────────┐
│ Queue for   │
│ Processing  │
└─────────────┘
     │
     ▼
┌─────────────┐
│ Face        │
│ Detection   │
└─────────────┘
     │
     ├── FAIL → Credit already charged, NO refund
     │
     ▼ PASS
     Done
```

**Rule:** 1 credit = 1 photo uploaded. Deduct after validation, before upload.

---

## Database Schema

| Table             | Key Columns                                                                                                                     | Notes                                     |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------- |
| `photographers`   | id, clerk_id, email, name, pdpa_consent_at, created_at                                                                          | Email always required                     |
| `credit_packages` | id, name, credits, price_thb, active, sort_order                                                                                | Admin-editable                            |
| `credit_ledger`   | id, photographer_id, amount, type, stripe_session_id, expires_at, created_at                                                    | 6-month expiry                            |
| `events`          | id, photographer_id, name, start_date, end_date, access_code, qr_code_r2_key, rekognition_collection_id, created_at, expires_at | Collection ID nullable until first upload |
| `photos`          | id, event_id, r2_key, status, face_count, uploaded_at                                                                           | Single r2_key (original only)             |
| `faces`           | id, photo_id, rekognition_face_id, bounding_box, indexed_at                                                                     | For search matching                       |
| `consent_records` | id, photographer_id, consent_type, granted_at, ip_address                                                                       | PDPA compliance                           |

**Key schema changes from v2:**

- `photos.jpeg_r2_key` removed — not needed
- `events.rekognition_collection_id` nullable — created on first upload
- `events.expires_at` added — 30 days after created_at

---

## Phase 0: Foundation

### Tasks

| Task | Surface | Description                                                             |
| ---- | ------- | ----------------------------------------------------------------------- |
| 0.1  | DB      | Create all tables via Drizzle migrations                                |
| 0.2  | API     | Implement `requirePhotographer()` middleware                            |
| 0.3  | API     | Create admin endpoints: `GET/POST/PATCH /admin/credit-packages`         |
| 0.4  | Config  | Configure Clerk: require email, 24h session, LINE email permission      |
| 0.5  | Infra   | Set up R2 lifecycle rule: delete objects 30 days after event expires_at |

---

## Phase 1: Auth (US-1, US-2)

### US-1: First-time photographer signs up

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User visits `/photographer/signup` |
| 2 | UI | Clicks Google/LINE/email |
| 3 | External | Clerk handles OAuth/email verification |
| 4 | External | If LINE doesn't provide email → Clerk prompts user to enter email |
| 5 | Webhook | `user.created` → API creates `photographers` row with email |
| 6 | UI | PDPA consent modal shown (blocking) |
| 7 | API | `POST /consent` records consent |
| 8 | UI | Redirect to dashboard |

**Clerk configuration:**

- Email: Required + Verify at sign-up
- Session lifetime: 24 hours
- LINE: Apply for email permission, configure scopes `openid profile email`

### US-2: Session persists

No changes from v2. 24-hour sessions with Clerk auto-refresh.

---

## Phase 2: Dashboard Core (US-3, US-4)

### US-3: Dashboard

No changes from v2.

### US-4: Credit package purchase

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User clicks "Buy Credits" on dashboard |
| 2 | UI | Navigate to `/credits/packages` (dedicated page) |
| 3 | API | `GET /credit-packages` returns active packages from DB |
| 4 | UI | User selects package |
| 5 | API | `POST /credits/checkout` creates Stripe session |
| 6 | External | Redirect to Stripe Checkout (PromptPay enabled) |
| 7 | Webhook | `checkout.session.completed` → insert `credit_ledger` row |
| 8 | UI | Success redirect → dashboard shows updated balance |

**Credit expiry:** `expires_at = NOW() + 6 months`

---

## Phase 3: Events (US-5, US-6)

### US-5: Create event

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User clicks "Create Event" → form modal |
| 2 | UI | Fill name, optional dates, submit |
| 3 | API | `POST /events` validates input |
| 4 | API | Generate unique `access_code` (6-char alphanumeric) |
| 5 | API | Generate QR code PNG via `@juit/qrcode` |
| 6 | API | Upload QR PNG to R2 |
| 7 | DB | Insert `events` row (rekognition_collection_id = NULL) |
| 8 | DB | Set `expires_at = created_at + 30 days` |
| 9 | UI | Show new event card with QR code |

**QR code encodes TWO URLs:**

```
Search:    https://sabaipics.com/search/{accessCode}
Slideshow: https://sabaipics.com/event/{accessCode}/slideshow
```

**Note:** Rekognition collection NOT created here (saves money). Created on first photo upload.

### US-6: QR code display and download

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | Event card shows QR thumbnail |
| 2 | UI | Shows both URLs: Search link + Slideshow link |
| 3 | UI | Click "Download QR" → fetch PNG from R2 |
| 4 | External | User scans QR → chooses search or slideshow |

**Slideshow URL:** Returns "Coming soon" page for now (out of scope for S-1).

---

## Phase 4: Upload & Face Detection (US-7, US-8, US-9)

### US-7: Background photo upload

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User drags photos or uses file picker |
| 2 | UI | Client-side validation: format + size |
| 3 | API | `POST /events/:id/photos` — server validation |
| 4 | API | **Validation PASS → Deduct 1 credit** |
| 5 | API | Check credit balance ≥ 1, else reject |
| 6 | API | Stream file to R2 (original format) |
| 7 | DB | Insert `photos` row: `status=processing` |
| 8 | Queue | Enqueue photo job |
| 9 | UI | Show "Processing..." badge |

**Validation checks (before credit deduction):**

- Format: JPEG, PNG, HEIC, WebP, RAW (CR2, NEF, ARW)
- Size: ≤ 50MB
- Auth: Valid photographer, owns event
- Event: Not expired

**Credit deduction:**

- Insert `credit_ledger` row: `amount=-1, type='upload'`
- If balance < 1: reject with "Insufficient credits" error

### US-8: Face detection and indexing

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | Queue | Photo job dequeued |
| 2 | Queue | Check if `events.rekognition_collection_id` is NULL |
| 3 | Queue | **If NULL:** Create Rekognition collection, save ID to DB |
| 4 | Queue | Fetch original from R2 |
| 5 | Queue | **If not JPEG/PNG:** Fetch via CF Images transform URL → get JPEG bytes |
| 6 | Queue | Call Rekognition `IndexFaces` with JPEG bytes |
| 7 | DB | Insert `faces` rows |
| 8 | DB | Update `photos`: `status=indexed`, `face_count=N` |

**CF Images transform for Rekognition:**

```
GET /cdn-cgi/image/format=jpeg,quality=90/photos.sabaipics.com/{r2_key}
→ Returns JPEG bytes (not stored, used directly for Rekognition)
```

**Failure handling:**
| Failure | Behavior | Credit refund? |
|---------|----------|----------------|
| No faces detected | Mark indexed, face_count=0 | No |
| Rekognition error | Mark failed, retry via queue | No |
| Conversion error | Mark failed | No |

### US-9: Event gallery

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User opens event detail page |
| 2 | API | `GET /events/:id/photos?cursor=X&limit=50` |
| 3 | UI | Render grid with CF Images thumbnails (400px) |
| 4 | UI | Click photo → lightbox with 1200px preview |
| 5 | UI | Download button → presigned R2 URL (original) |

**Thumbnail URL:**

```
/cdn-cgi/image/width=400,fit=cover,format=auto/photos.sabaipics.com/{r2_key}
```

**Preview URL:**

```
/cdn-cgi/image/width=1200,fit=contain,format=auto/photos.sabaipics.com/{r2_key}
```

**Download:** Presigned R2 URL to original file.

---

## Data Retention & Cleanup

| Data                   | Retention                      | Cleanup mechanism                  |
| ---------------------- | ------------------------------ | ---------------------------------- |
| Event (DB record)      | 30 days after created_at       | Soft delete, keep metadata         |
| Photos (R2 originals)  | 30 days after event created_at | R2 lifecycle rule                  |
| QR codes (R2)          | 30 days after event created_at | R2 lifecycle rule                  |
| Rekognition collection | 30 days after event created_at | Cleanup job calls DeleteCollection |
| Faces (DB records)     | Cascade delete with photos     | FK cascade                         |

**Implementation:**

1. R2 lifecycle policy: Delete objects where `events.expires_at < NOW()`
2. Cron job (daily): Find expired events → delete Rekognition collections → soft-delete DB records

---

## API-first Sequencing

```
Phase 0 (Foundation)
  ├─ DB: All tables + migrations
  ├─ API: requirePhotographer middleware
  ├─ API: Admin credit-packages CRUD
  └─ Config: Clerk (email required, 24h, LINE email)
       │
Phase 1 (Auth) ─────────────────────────────────────────────────────
  ├─ API: POST /consent, Clerk webhook
  └─ UI: Signup flow, PDPA modal
       │
Phase 2 (Dashboard) ────────────────────────────────────────────────
  ├─ API: GET /dashboard, GET /credit-packages, POST /credits/checkout
  ├─ Webhook: Stripe handler (idempotent)
  └─ UI: Dashboard, /credits/packages page
       │
Phase 3 (Events) ───────────────────────────────────────────────────
  ├─ API: POST /events, GET /events, GET /events/:id
  ├─ Lib: QR generation with 2 URLs
  └─ UI: Event CRUD, QR display
       │
Phase 4 (Upload) ───────────────────────────────────────────────────
  ├─ API: POST /events/:id/photos (with credit deduction)
  ├─ API: GET /events/:id/photos
  ├─ Queue: Lazy collection creation + CF Images convert + Rekognition
  └─ UI: Upload dropzone, gallery grid
       │
Cleanup (Cron) ─────────────────────────────────────────────────────
  └─ Job: Delete expired events (R2 lifecycle + Rekognition + DB)
```

---

## Success Path (End-to-End)

1. Photographer signs up via LINE on `/photographer/signup`
2. LINE doesn't provide email → Clerk prompts for email
3. Accepts PDPA consent
4. Lands on empty dashboard (0 credits)
5. Navigates to `/credits/packages`, buys 100-credit package via PromptPay
6. Creates "Wedding 2026-01-15" event → gets QR with 2 URLs
7. Downloads QR code for guests
8. Uploads 50 wedding photos (HEIC from iPhone)
9. Each upload: validation → deduct 1 credit → store original → queue
10. Queue: create Rekognition collection (first photo) → convert HEIC → index faces
11. Views gallery with 50 photos, fast thumbnails (CDN cached)
12. 30 days later: event expires, originals deleted, Rekognition collection deleted

---

## Tradeoffs & Follow-ups

### Non-goals / Out of scope

- `[OUT_OF_SCOPE]` FTP upload (W-3)
- `[OUT_OF_SCOPE]` Event slideshow (W-4) — URL exists, shows "Coming soon"
- `[OUT_OF_SCOPE]` Gallery share link (W-7)
- `[OUT_OF_SCOPE]` LINE notifications (W-10)
- `[OUT_OF_SCOPE]` Participant selfie search (S-2)
- `[OUT_OF_SCOPE]` Face-aware thumbnail cropping
- `[OUT_OF_SCOPE]` Admin UI for credit packages (API only)

### Accepted compromises

- `[ACCEPTED_FOR_NOW]` No chunked/resumable uploads
- `[ACCEPTED_FOR_NOW]` No real-time WebSocket progress
- `[ACCEPTED_FOR_NOW]` 30-day retention is fixed (no photographer extension)

### Risks & mitigations

- `[RISK]` Large RAW files (50MB) may timeout → Consider presigned URL direct-to-R2
- `[RISK]` CF Images conversion latency → Async in queue, user sees "processing"
- `[RISK]` Rekognition 50 TPS limit → Rate limiter DO exists

### Follow-ups

- `[PM_FOLLOWUP]` Define exact credit package pricing
- `[PM_FOLLOWUP]` PDPA consent copy review
- `[PM_FOLLOWUP]` LINE email permission application
- `[ENG_DEBT]` Structured logging with correlation IDs
- `[ENG_DEBT]` Component tests for dashboard
- `[ENG_DEBT]` Admin UI for credit packages

---

## References

- Research: `docs/logs/BS_0001_S-1/research/*.md`
- Decisions: `docs/logs/BS_0001_S-1/decisions-input.md`
- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
