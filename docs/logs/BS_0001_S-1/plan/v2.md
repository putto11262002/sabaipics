# Execution Plan (P)

Execution root: `BS_0001_S-1`
Upstream (PM): slice `d999677d-0b51-4b3b-b163-eec36a5bdde3` (S-1: Photographer Onboarding & Photo Upload)
Date: `2026-01-09`
Owner: Tech Lead (AI-assisted)

## Inputs
- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
- Context reports:
  - `docs/logs/BS_0001_S-1/context/repo-scout.md`
  - `docs/logs/BS_0001_S-1/context/surface-map.md`
  - `docs/logs/BS_0001_S-1/context/risk-scout.md`
- Research:
  - `docs/logs/BS_0001_S-1/research/heic-rekognition.md`
  - `docs/logs/BS_0001_S-1/research/cf-images-thumbnails.md`
  - `docs/logs/BS_0001_S-1/research/qr-code-library.md`
  - `docs/logs/BS_0001_S-1/research/stripe-credit-flow.md`
- Decisions: `docs/logs/BS_0001_S-1/decisions-input.md`

---

## Decisions Applied (from v1 → v2)

| # | Decision | Resolution | ADR |
|---|----------|------------|-----|
| 1 | Session timeout | **24 hours** (convenience for event-day uploads) | — |
| 2 | HEIC/RAW handling | **Support & convert via CF Images** → JPEG before Rekognition | — |
| 3 | Credit packages | **Store in DB** (admin-editable prices & credit amounts) | — |
| 4 | User type verification | **Not needed** — Participants have no auth; only photographers sign up | — |
| 5 | Thumbnails | **On-demand via CF Images URL** (no pre-generation) | — |
| 6 | Face-aware cropping | **Out of scope** for MVP | — |
| 7 | Thumbnail sizes | **400px** grid / **1200px** preview | — |
| 8 | QR codes | **Eager generation** on event create | — |
| 9 | PromptPay | **Enabled** for Thai market | — |
| 10 | Credit expiration | **6 months** from purchase date | — |

---

## Current Approach (P)

### High-level Strategy

**Foundation-first, API-first** approach:
1. **Phase 0 (Foundation)**: DB schema + migrations for all domain tables
2. **Phase 1 (Auth)**: Photographer signup + session management (US-1, US-2)
3. **Phase 2 (Dashboard Core)**: Dashboard + credit purchase (US-3, US-4)
4. **Phase 3 (Events)**: Event creation + QR codes (US-5, US-6)
5. **Phase 4 (Upload)**: Photo upload + face detection + gallery (US-7, US-8, US-9)

Each phase: **API endpoints first**, then UI integration.

### Key Architecture Decisions

| Component | Decision | Rationale |
|-----------|----------|-----------|
| Auth | Clerk (photographers only) | Participants anonymous via QR scan |
| Sessions | 24h duration | Event-day convenience |
| Payments | Stripe Checkout + PromptPay | Thai market standard |
| Credit packages | DB-stored | Admin-editable without deploys |
| Image formats | JPEG/PNG/HEIC/WebP/RAW accepted | CF Images converts → JPEG for Rekognition |
| Thumbnails | CF Images on-demand transforms | No pre-generation, edge-cached |
| QR codes | @juit/qrcode, eager generation | PNG stored in R2 on event create |
| Face detection | AWS Rekognition IndexFaces | Collection per event |

---

## Phase 0: Foundation (DB Schema)

**Stories**: None directly, but prerequisite for all

### Database Tables

| Table | Key Columns | Notes |
|-------|-------------|-------|
| `photographers` | id, clerk_id, email, name, pdpa_consent_at, created_at | Links to Clerk user |
| `credit_packages` | id, name, credits, price_thb, active, sort_order | Admin-editable |
| `credit_ledger` | id, photographer_id, amount, type, stripe_session_id, expires_at, created_at | 6-month expiry |
| `events` | id, photographer_id, name, start_date, end_date, access_code, qr_code_r2_key, rekognition_collection_id, created_at | QR stored in R2 |
| `photos` | id, event_id, original_r2_key, jpeg_r2_key, status, face_count, uploaded_at | Original + converted paths |
| `faces` | id, photo_id, rekognition_face_id, bounding_box, indexed_at | For search matching |
| `consent_records` | id, photographer_id, consent_type, granted_at, ip_address | PDPA compliance |

### Phase 0 Tasks

| Task | Surface | Description |
|------|---------|-------------|
| 0.1 | DB | Create all tables via Drizzle migrations |
| 0.2 | API | Implement `requirePhotographer()` middleware with DB lookup |
| 0.3 | API | Create admin endpoints for credit packages CRUD |

---

## Phase 1: Auth (US-1, US-2)

### US-1: First-time photographer signs up

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
<mark data-comment="1">| 1 | UI | User clicks Google/LINE/email on `/photographer/signup` |</mark>
<!-- COMMENT-1: Require user email. I think clerk handlers that right we we check require email for sso that does not capture it ask user to enter right? -->
| 2 | External | Clerk handles OAuth/email verification |
| 3 | Webhook | `user.created` → API creates `photographers` row |
| 4 | UI | PDPA consent modal shown (blocking) |
| 5 | API | `POST /consent` records consent, updates `photographers.pdpa_consent_at` |
| 6 | UI | Redirect to dashboard |

**Failure modes:**
| ID | Failure | Behavior | Recovery |
|----|---------|----------|----------|
| FP-1 | OAuth failure | Clerk shows error | Retry or try different provider |
| FP-2 | Webhook fails | Svix retries 5x | Manual resync if DLQ |
| FP-3 | PDPA declined | Block dashboard access | Show explanation, allow retry |

**API Contracts:**
```
POST /consent
Body: { type: "pdpa", granted: true }
Response: { success: true }
```

### US-2: Session persists and auto-restores

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | Returning user opens dashboard |
| 2 | Auth | Clerk SDK checks session (24h validity) |
| 3 | UI | Valid session → show dashboard |

**Failure modes:**
| ID | Failure | Behavior | Recovery |
|----|---------|----------|----------|
| FP-1 | Session expired | Clerk redirects to sign-in | Re-authenticate |
| FP-2 | Token revoked | Same as expired | Re-authenticate |

**Configuration:** Set Clerk session lifetime to 24 hours in Clerk Dashboard.

---

## Phase 2: Dashboard Core (US-3, US-4)

### US-3: Dashboard displays credit balance, events, quick actions

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | Dashboard page loads |
| 2 | API | `GET /dashboard` fetches data |
| 3 | DB | Query `credit_ledger` (sum non-expired), `events` (list) |
| 4 | UI | Render credit balance, event list, CTA buttons |

**API Contract:**
```
GET /dashboard
Response: {
  credits: { balance: number, nearestExpiry?: string },
  events: [{ id, name, photoCount, faceCount, createdAt }],
  stats: { totalPhotos, totalFaces }
}
```

**Credit balance query:** Sum `credit_ledger.amount` where `expires_at > NOW()`.

### US-4: Credit package purchase

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
<mark data-comment="2">| 1 | UI | User clicks "Buy Credits" → modal shows packages from DB |</mark>
<!-- COMMENT-2: i think a didecated page for pages better? because it can grow. -->
| 2 | API | `GET /credit-packages` returns active packages |
| 3 | UI | User selects package |
| 4 | API | `POST /credits/checkout` creates Stripe session |
| 5 | External | Redirect to Stripe Checkout (PromptPay enabled) |
| 6 | Webhook | `checkout.session.completed` → insert `credit_ledger` row |
| 7 | UI | Success redirect → dashboard shows updated balance |

**API Contracts:**
```
GET /credit-packages
Response: [{ id, name, credits, priceTHB }]

POST /credits/checkout
Body: { packageId: string }
Response: { checkoutUrl: string }
```

**Webhook handling:**
- Idempotency: Use `stripe_session_id` as unique key
- Credit expiry: `expires_at = NOW() + 6 months`

**Failure modes:**
| ID | Failure | Behavior | Recovery |
|----|---------|----------|----------|
| FP-1 | Payment declined | Stripe shows error | Retry with different method |
| FP-2 | Webhook delayed | Credits not visible yet | Poll or show "Processing..." |
| FP-3 | Duplicate webhook | Idempotency key prevents double-credit | — |

---

## Phase 3: Events (US-5, US-6)

### US-5: Create event with name and optional dates

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User clicks "Create Event" → form modal |
| 2 | UI | Fill name, optional dates, submit |
| 3 | API | `POST /events` validates input |
| 4 | API | Generate unique `access_code` (6-char alphanumeric) |
| 5 | API | Generate QR code PNG via `@juit/qrcode` |
| 6 | API | Upload QR PNG to R2 |
<mark data-comment="3">| 7 | API | Create Rekognition collection for event |</mark>
<!-- COMMENT-3: no do this when first upload image. because calls to rekognition cost money we dont wnt to assume tht all created event will ended up with images upload right. -->
| 8 | DB | Insert `events` row |
| 9 | UI | Show new event card with QR code |

**API Contract:**
```
POST /events
Body: { name: string, startDate?: string, endDate?: string }
Response: { id, name, accessCode, qrCodeUrl, createdAt }
```

**QR Code URL encoded:** `https://sabaipics.com/search/{accessCode}`

### US-6: QR code display and download

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | Event card shows QR thumbnail (from R2 via CF Images) |
| 2 | UI | Click "Download QR" → fetch full-size PNG from R2 |
| 3 | External | User scans QR → opens selfie search page |
<mark data-comment="4"></mark>
<!-- COMMENT-4: Ok i think we need the url to the evnet gallery slide show just create trhe link for now without imeplemt the sldieshow (not in scope) or should we make the url gnerate now? -->
---

## Phase 4: Upload & Face Detection (US-7, US-8, US-9)

### US-7: Background photo upload

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User drags photos or uses file picker |
| 2 | UI | Validate: JPEG/PNG/HEIC/WebP/RAW, max 50MB |
| 3 | UI | Queue files, show per-file progress |
| 4 | API | `POST /events/:id/photos` streams file to R2 (original) |
| 5 | DB | Insert `photos` row with `status=uploading` |
| 6 | Queue | Enqueue photo job for processing |
| 7 | UI | Show "Uploaded, processing..." badge |

**API Contract:**
```
POST /events/:id/photos
Body: multipart/form-data (file)
Response: { photoId, status: "processing" }
```

**Accepted formats:** JPEG, PNG, HEIC, WebP, RAW (CR2, NEF, ARW)
**Max size:** 50MB (pro camera RAW files can be 30-50MB)

**Failure modes:**
| ID | Failure | Behavior | Recovery |
|----|---------|----------|----------|
| FP-1 | Upload fails mid-stream | Client shows error | Retry button |
| FP-2 | Unsupported format | Reject with clear error | List supported formats |
| FP-3 | File too large | Reject with size limit message | — |

### US-8: Automatic face detection and indexing

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | Queue | Photo job dequeued |
| 2 | Queue | Fetch original from R2 |
| 3 | Queue | **If not JPEG:** Call CF Images transform → get JPEG |
| 4 | Queue | Upload JPEG to R2 (for Rekognition) |
| 5 | Queue | Call Rekognition `IndexFaces` with JPEG |
| 6 | DB | Insert `faces` rows with rekognition_face_id, bounding_box |
| 7 | DB | Update `photos`: `status=indexed`, `face_count=N`, `jpeg_r2_key` |
| 8 | Queue | Ack message |

**Image conversion flow:**
```
Original (HEIC/RAW/WebP) → CF Images Transform → JPEG → R2 → Rekognition
```

**Failure modes:**
| ID | Failure | Behavior | Recovery |
|----|---------|----------|----------|
| FP-1 | No faces detected | Mark `indexed` with `face_count=0` | Still show in gallery |
| FP-2 | Rekognition throttled | Rate limiter DO enforces backoff | Queue retries |
| FP-3 | Conversion fails | Mark `status=failed` | Show error badge, allow re-upload |
| FP-4 | Rekognition unavailable | Exponential backoff, DLQ after 3 | Alert, manual retry |

### US-9: Event gallery displays photos

**HP-0 (Happy path):**
| Step | Surface | Action |
|------|---------|--------|
| 1 | UI | User opens event detail page |
| 2 | API | `GET /events/:id/photos?cursor=X&limit=50` |
| 3 | DB | Query `photos` for event, paginated |
| 4 | UI | Render grid with thumbnails (CF Images 400px), face count badges |
| 5 | UI | Click photo → lightbox with 1200px preview |

**API Contract:**
```
GET /events/:id/photos?cursor=X&limit=50
Response: {
  photos: [{ id, thumbnailUrl, previewUrl, faceCount, status }],
  nextCursor?: string
}
```

**Thumbnail URL pattern:**
```
/cdn-cgi/image/width=400,fit=cover,format=auto/photos.sabaipics.com/{jpeg_r2_key}
```

**Preview URL pattern:**
```
/cdn-cgi/image/width=1200,fit=contain,format=auto/photos.sabaipics.com/{jpeg_r2_key}
```

---

## API-first Sequencing (invariant)

```
Phase 0 (Foundation)
  └─ DB: All tables via Drizzle migrations
  └─ API: requirePhotographer middleware, admin credit-packages CRUD
       │
Phase 1 (Auth) ─────────────────────────────────────────────────────
  ├─ API: POST /consent, Clerk webhook handler
  ├─ Config: Clerk 24h session
  └─ UI: Sign-up flow, PDPA modal
       │
Phase 2 (Dashboard) ────────────────────────────────────────────────
  ├─ API: GET /dashboard, GET /credit-packages, POST /credits/checkout
  ├─ Webhook: Stripe checkout.session.completed handler
  └─ UI: Dashboard page, credit purchase modal
       │
Phase 3 (Events) ───────────────────────────────────────────────────
  ├─ API: POST /events, GET /events, GET /events/:id
  ├─ Lib: QR code generation (@juit/qrcode)
  └─ UI: Event creation modal, event list, QR display
       │
Phase 4 (Upload) ───────────────────────────────────────────────────
  ├─ API: POST /events/:id/photos, GET /events/:id/photos
<mark data-comment="5">  ├─ Queue: Photo consumer with CF Images conversion + Rekognition</mark>
<!-- COMMENT-5: Where is te credit deduction tho. Some context only deduct credit afer validation fail to validate does not cost .but any failture after that cost money. -->
  └─ UI: Upload dropzone, gallery grid with lightbox
```

---

## Success Path (End-to-End)

1. Photographer signs up via Google on `/photographer/signup`
2. Accepts PDPA consent
3. Lands on empty dashboard
4. Buys 100-credit package via Stripe (PromptPay)
5. Creates "Wedding 2026-01-15" event
6. Downloads QR code for guests
7. Uploads 50 wedding photos (mix of JPEG and HEIC)
8. HEIC photos converted to JPEG automatically
9. Face detection completes with face counts
10. Views gallery with all 50 photos, thumbnails load fast
<mark data-comment="6"></mark>
<!-- COMMENT-6: So we store files or images and embedings for one month Ok. clean up ? -->
---

## Tradeoffs & Follow-ups

### Non-goals / Out of scope
- `[OUT_OF_SCOPE]` FTP upload (W-3) — excluded from S-1
- `[OUT_OF_SCOPE]` Event slideshow (W-4) — excluded from S-1
- `[OUT_OF_SCOPE]` Gallery share link (W-7) — excluded from S-1
- `[OUT_OF_SCOPE]` LINE notifications (W-10) — excluded from S-1
- `[OUT_OF_SCOPE]` Participant selfie search — S-2
- `[OUT_OF_SCOPE]` Face-aware thumbnail cropping — can add later

### Accepted compromises
- `[ACCEPTED_FOR_NOW]` No chunked/resumable uploads — monitor failure rates
- `[ACCEPTED_FOR_NOW]` No real-time WebSocket progress — polling acceptable for MVP
- `[ACCEPTED_FOR_NOW]` No admin UI for credit packages — use API/DB directly

### Risks & mitigations
- `[RISK]` **Large RAW files (50MB) may timeout** — Mitigation: Increase Worker timeout, consider presigned URL direct-to-R2
- `[RISK]` **CF Images conversion latency** — Mitigation: Async in queue, user sees "processing" status
- `[RISK]` **Rekognition 50 TPS limit** — Mitigation: Rate limiter DO already exists

### Follow-ups
- `[PM_FOLLOWUP]` Define exact credit package pricing (amounts, THB prices)
- `[PM_FOLLOWUP]` PDPA consent copy and legal review
- `[ENG_DEBT]` Add structured logging with correlation IDs
- `[ENG_DEBT]` Dashboard component tests
- `[ENG_DEBT]` Admin UI for credit packages (post-MVP)

---

## References
- Research: `docs/logs/BS_0001_S-1/research/*.md`
- Decisions: `docs/logs/BS_0001_S-1/decisions-input.md`
- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
- Context: `docs/logs/BS_0001_S-1/context/*.md`
