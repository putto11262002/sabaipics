# Execution Plan (P*)

Execution root: `BS_0001_S-1`
Upstream (PM): slice `d999677d-0b51-4b3b-b163-eec36a5bdde3` (S-1: Photographer Onboarding & Photo Upload)
Date: `2026-01-09`
Owner: Tech Lead (AI-assisted)

## Inputs
- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
- Context reports:
  - `docs/logs/BS_0001_S-1/context/repo-scout.md`
  - `docs/logs/BS_0001_S-1/context/surface-map.md`
  - `docs/logs/BS_0001_S-1/context/risk-scout.md`

---

## Decision queue

| # | Decision | Options | ADR topic | Blocking? |
|---|----------|---------|-----------|-----------|
| 1 | `[NEED_DECISION]` Session timeout policy | A) 24h (convenience) / B) 4h+refresh (balanced) / C) 1h strict | `session-policy` | Yes (US-2) |
| 2 | `[NEED_DECISION]` HEIC/RAW file handling | A) Convert on upload, reject RAW / B) Convert in queue / C) Cloudflare Images on-the-fly | `image-format-handling` | Yes (US-7, US-8) |
| 3 | `[NEED_DECISION]` Credit package pricing approach | A) Hardcode in API / B) Store in DB / C) Stripe Products/Prices | `credit-packages` | Yes (US-4) |
| 4 | `[NEED_DECISION]` User type verification (photographer vs participant) | A) Separate Clerk apps / B) Admin approval queue / C) Signup URL validation + soft-lock | `user-type-verification` | Yes (US-1) |

---

## Current approach (P*)

### High-level strategy

**Foundation-first, API-first** approach:
1. **Phase 0 (Foundation)**: DB schema + migrations for all domain tables
2. **Phase 1 (Auth)**: Extend auth for photographer signup (US-1, US-2)
3. **Phase 2 (Dashboard Core)**: Dashboard + credits (US-3, US-4)
4. **Phase 3 (Events)**: Event creation + QR codes (US-5, US-6)
5. **Phase 4 (Upload)**: Photo upload + face detection (US-7, US-8, US-9)

Each phase: API endpoints first, then UI integration.

### Known (repo exemplars)
- **Clerk auth**: Integrated, JWT validation works (`packages/auth/src/middleware.ts`)
- **Stripe**: Checkout session + webhook handlers scaffolded (`apps/api/src/lib/stripe/`)
- **Rekognition**: Client + rate limiter + queue consumer ready (`apps/api/src/lib/rekognition/`, `apps/api/src/queue/photo-consumer.ts`)
- **R2 + Queues**: Configured in `wrangler.jsonc`, photo queue consumer exists
- **Validation pattern**: Zod with discriminated unions (`apps/api/src/lib/line/schemas.ts`)
- **Error pattern**: Domain-specific error modules with retry classification (`apps/api/src/lib/rekognition/errors.ts`)
- **Protected routes**: `requireAuth()` middleware chain

### Assumptions `[NEED_VALIDATION]`
- `[NEED_VALIDATION]` Clerk supports LINE OAuth (mentioned in webhook handler but not verified in Clerk dashboard config)
- `[NEED_VALIDATION]` Rekognition supports HEIC input directly (may need conversion)
- `[NEED_VALIDATION]` Cloudflare Images can generate thumbnails from R2 objects

### Open gaps `[GAP]`
- `[GAP]` **No DB schema**: Only test table exists. Must create: `photographers`, `events`, `event_access`, `photos`, `faces`, `credit_ledger`, `payments`, `consent_records`
- `[GAP]` **No PDPA consent flow**: Required before face detection can run (FR-21)
- `[GAP]` **No QR code library**: Need to add QR generation for event access codes

---

## Phase breakdown (P*)

### Phase 0: Foundation (DB Schema)
**Stories**: None directly, but prerequisite for all

| Task | Surface | Description | Dependencies |
|------|---------|-------------|--------------|
| 0.1 | DB | Create `photographers` table (id, clerk_id, email, name, created_at, pdpa_consent_at) | - |
| 0.2 | DB | Create `credit_ledger` table (id, photographer_id, amount, type, stripe_session_id, created_at) | 0.1 |
| 0.3 | DB | Create `events` table (id, photographer_id, name, start_date, end_date, access_code, qr_code_url, created_at) | 0.1 |
| 0.4 | DB | Create `photos` table (id, event_id, r2_key, status, face_count, uploaded_at) | 0.3 |
| 0.5 | DB | Create `faces` table (id, photo_id, rekognition_face_id, bounding_box, indexed_at) | 0.4 |
| 0.6 | DB | Create `consent_records` table (id, photographer_id, consent_type, granted_at, ip_address) | 0.1 |
| 0.7 | API | Implement `requirePhotographer()` middleware with DB lookup | 0.1 |

**Risk**: Schema design impacts all downstream work. Use deprecated docs schema as starting point (`docs/deprecated/tech/01_data_schema.md`).

---

### Phase 1: Auth (US-1, US-2)

**US-1: First-time photographer signs up with social login or email**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | User clicks Google/LINE/email on sign-up page |
| Step 2 (API) | Clerk handles OAuth/email verification |
| Step 3 (Webhook) | Clerk webhook `user.created` fires → API creates `photographers` row |
| Step 4 (UI) | PDPA consent modal shown |
| Step 5 (API) | `POST /consent` records consent, updates `photographers.pdpa_consent_at` |
| Step 6 (UI) | Redirect to dashboard |

**Failure modes**:
- `FP-1 (OAuth failure)`: Clerk OAuth fails → Clerk shows error, user can retry or try different provider
- `FP-2 (Webhook failure)`: Clerk webhook fails → Svix retries; user sees "Setting up account..." state
- `FP-3 (Consent declined)`: User declines PDPA → Block access, show explanation, allow retry
- `FP-4 (Duplicate signup)`: User with same email → Clerk handles dedup; webhook checks existing photographer row

`[NEED_DECISION]` **User type verification**: How do we know this is a photographer, not a participant?
- Option A: Separate Clerk apps (cleanest, but two integrations)
- Option B: Admin approval queue (friction)
- Option C: Signup URL validation (`/photographer/signup` vs `/search`) + immediate soft-lock if suspicious (quickest MVP)

**US-2: Session persists and auto-restores**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | Returning user opens dashboard |
| Step 2 (Auth) | Clerk SDK checks session, auto-refreshes if near expiry |
| Step 3 (UI) | Valid session → show dashboard |

**Failure modes**:
- `FP-1 (Session expired)`: Token expired → Clerk SDK redirects to sign-in
- `FP-2 (Token revoked)`: Admin revoked → Same as expired

`[NEED_DECISION]` **Session timeout**: Clerk default vs custom? Options: 24h / 4h+refresh / 1h strict

---

### Phase 2: Dashboard Core (US-3, US-4)

**US-3: Dashboard displays credit balance, events, and quick actions**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | Dashboard page loads |
| Step 2 (API) | `GET /dashboard` returns { credits, events, stats } |
| Step 3 (DB) | Query `credit_ledger` (sum), `events` (count + recent) |
| Step 4 (UI) | Render credit balance, event list, CTA buttons |

**API contract**:
```
GET /dashboard
Response: {
  credits: { balance: number, expiresAt?: string },
  events: { id, name, photoCount, createdAt }[],
  stats: { totalPhotos, totalFaces }
}
```

**US-4: Select and complete credit package purchase**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | User clicks "Buy Credits" → modal shows packages |
| Step 2 (API) | `POST /credits/checkout` with { packageId } |
| Step 3 (Stripe) | Create checkout session, return URL |
| Step 4 (UI) | Redirect to Stripe Checkout |
| Step 5 (Webhook) | `checkout.session.completed` → insert into `credit_ledger` |
| Step 6 (UI) | Success redirect → dashboard shows updated balance |

**Failure modes**:
- `FP-1 (Payment declined)`: Stripe returns decline → Show error, allow retry
- `FP-2 (Webhook delayed)`: Checkout completed but credits not yet visible → Show "Processing..." state, poll or use Stripe redirect metadata
- `FP-3 (Duplicate webhook)`: Stripe sends same event twice → Use `stripe_session_id` as idempotency key

`[NEED_DECISION]` **Credit packages**: Where to define packages?
- Option A: Hardcode in API (simple, requires deploy to change)
- Option B: Store in DB (admin UI needed)
- Option C: Use Stripe Products/Prices directly (most flexible)

---

### Phase 3: Events (US-5, US-6)

**US-5: Create event with name and optional dates**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | User clicks "Create Event" → form modal |
| Step 2 (UI) | Fill name, optional dates, submit |
| Step 3 (API) | `POST /events` validates, generates access_code, creates row |
| Step 4 (API) | Generate QR code (encode access URL), upload to R2 |
| Step 5 (DB) | Insert `events` row with qr_code_url |
| Step 6 (API) | Initialize Rekognition collection for event |
| Step 7 (UI) | Show new event card with QR code |

**API contract**:
```
POST /events
Body: { name: string, startDate?: string, endDate?: string }
Response: { id, name, accessCode, qrCodeUrl, createdAt }
```

`[GAP]` Need QR code library. Options: `qrcode` npm package, generate server-side as PNG, upload to R2.

**US-6: QR code links to selfie search and is downloadable**

Depends on US-5. QR code generated at event creation.

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | Event card shows QR code thumbnail |
| Step 2 (UI) | Click "Download QR" → fetch from R2, trigger download |
| Step 3 (External) | User scans QR with phone camera |
| Step 4 (External) | Opens `https://sabaipics.com/search/{accessCode}` |

---

### Phase 4: Upload & Face Detection (US-7, US-8, US-9)

**US-7: Background photo upload with immediate processing**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | User drags photos or uses file picker |
| Step 2 (UI) | Files queued, progress shown per-file |
| Step 3 (API) | `POST /events/:id/photos` streams each file to R2 |
| Step 4 (DB) | Insert `photos` row with status=`uploading` |
| Step 5 (Queue) | Enqueue photo job for face detection |
| Step 6 (UI) | Show "Uploaded, processing..." badge |

**Failure modes**:
- `FP-1 (Upload fails mid-stream)`: Network error → Client retries, server checks for partial R2 object
- `FP-2 (Unsupported format)`: HEIC/WebP on unsupported browser → Validate client-side, show error with format list
- `FP-3 (File too large)`: >5MB → Reject with clear error
- `FP-4 (Rate limit)`: Too many concurrent uploads → Queue on client, process sequentially

`[NEED_DECISION]` **HEIC handling**: Convert on upload vs in queue vs Cloudflare Images?
`[NEED_RESEARCH]` Does Rekognition accept HEIC directly?

**US-8: Automatic face detection and indexing**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (Queue) | Photo job dequeued |
| Step 2 (Queue) | Fetch photo from R2 |
| Step 3 (Rekognition) | Call `IndexFaces` with collection ID = event ID |
| Step 4 (DB) | Insert `faces` rows with rekognition_face_id, bounding_box |
| Step 5 (DB) | Update `photos` row: status=`indexed`, face_count=N |
| Step 6 (WS/Poll) | Notify UI of completion |

**Failure modes**:
- `FP-1 (No faces detected)`: IndexFaces returns 0 faces → Mark photo as `indexed` with face_count=0, still show in gallery
- `FP-2 (Rekognition throttle)`: 50 TPS limit hit → Rate limiter DO enforces backoff, queue retries
- `FP-3 (Image format error)`: Rekognition rejects format → Mark as `failed`, show error badge
- `FP-4 (Rekognition unavailable)`: Service down → Queue retries with exponential backoff, DLQ after 3 attempts

`[NEED_VALIDATION]` Rekognition IndexFaces collection-per-event pattern (vs single collection with external IDs)

**US-9: Event gallery displays photos with face counts**

| HP-0 (Happy path) | |
|-------------------|---|
| Step 1 (UI) | User opens event detail page |
| Step 2 (API) | `GET /events/:id/photos` returns paginated photos |
| Step 3 (UI) | Render grid with thumbnails, face count badges, status indicators |
| Step 4 (UI) | Click photo → full-size view |

**API contract**:
```
GET /events/:id/photos?cursor=X&limit=50
Response: {
  photos: { id, thumbnailUrl, faceCount, status }[],
  nextCursor?: string
}
```

`[NEED_VALIDATION]` Cloudflare Images for thumbnail generation from R2

---

## API-first sequencing (invariant)

All stories follow: **DB schema → API endpoint → UI integration**

```
Phase 0 (Foundation)
  └─ DB: photographers, credit_ledger, events, photos, faces, consent_records
       │
Phase 1 (Auth) ────────────────────────────────────────────────────────────
  ├─ API: POST /consent, webhook handler updates
  └─ UI: Sign-up flow, PDPA modal, session handling
       │
Phase 2 (Dashboard) ───────────────────────────────────────────────────────
  ├─ API: GET /dashboard, POST /credits/checkout
  └─ UI: Dashboard page, credit purchase flow
       │
Phase 3 (Events) ──────────────────────────────────────────────────────────
  ├─ API: POST /events, GET /events, GET /events/:id
  └─ UI: Event creation, event list, QR display
       │
Phase 4 (Upload) ──────────────────────────────────────────────────────────
  ├─ API: POST /events/:id/photos, GET /events/:id/photos
  ├─ Queue: Face detection consumer (already exists, needs DB wiring)
  └─ UI: Upload dropzone, gallery grid
```

---

## Success path

**HP-0 (End-to-end happy path):**
1. Photographer signs up via Google
2. Accepts PDPA consent
3. Lands on empty dashboard
4. Buys 100-credit package via Stripe
5. Creates "Wedding 2026-01-15" event
6. Downloads QR code for guests
7. Uploads 50 wedding photos
8. Sees face detection complete with face counts
9. Views gallery with all 50 photos

---

## Failure modes / edge cases (major)

| ID | Failure | Occurs at | Behavior | Recovery |
|----|---------|-----------|----------|----------|
| FP-1 | OAuth provider down | US-1 Step 2 | Clerk shows error | User tries different provider |
| FP-2 | Webhook delivery fails | US-1 Step 3 | Svix retries (5x) | Manual resync if DLQ |
| FP-3 | PDPA consent declined | US-1 Step 4 | Block dashboard access | Show explanation, allow retry |
| FP-4 | Payment declined | US-4 Step 4 | Stripe shows decline reason | User fixes card, retries |
| FP-5 | Stripe webhook delayed | US-4 Step 5 | Credits not visible immediately | Poll or show "Processing" |
| FP-6 | Upload network failure | US-7 Step 3 | Upload fails mid-stream | Client-side retry |
| FP-7 | Rekognition throttled | US-8 Step 3 | 50 TPS exceeded | Rate limiter + queue retry |
| FP-8 | Rekognition format error | US-8 Step 3 | HEIC/RAW rejected | Mark failed, show error badge |
| FP-9 | Large batch processing slow | US-8 | 100+ photos take minutes | Show progress, async completion |

---

## Tradeoffs & Follow-ups

### Non-goals / Out of scope
- `[OUT_OF_SCOPE]` FTP upload (W-3) — excluded from S-1
- `[OUT_OF_SCOPE]` Event slideshow (W-4) — excluded from S-1
- `[OUT_OF_SCOPE]` Gallery share link (W-7) — excluded from S-1
- `[OUT_OF_SCOPE]` LINE notifications (W-10) — excluded from S-1
- `[OUT_OF_SCOPE]` Participant selfie search — S-2

### Accepted compromises (acceptable for now)
- `[ACCEPTED_FOR_NOW]` No chunked/resumable uploads for MVP — adds complexity; monitor failure rates post-launch
- `[ACCEPTED_FOR_NOW]` No real-time upload progress via WebSocket — polling is simpler, acceptable for MVP
- `[ACCEPTED_FOR_NOW]` Single Rekognition collection per event — may need cross-event search later (S-2 will clarify)

### Risks & mitigations
- `[RISK]` **Face detection latency for large batches** — Mitigation: Show clear progress UI, set expectations in copy
- `[RISK]` **HEIC browser compatibility varies** — Mitigation: Research browser support, add client-side validation
- `[RISK]` **Clerk `unsafe_metadata` for user type is insecure** — Mitigation: Decide on verification approach (Decision #4)
- `[RISK]` **Payment provider integration complexity** — Mitigation: Use existing Stripe scaffolding, test with sandbox first

### Follow-ups
- `[PM_FOLLOWUP]` Define exact credit package pricing (amounts, THB prices)
- `[PM_FOLLOWUP]` PDPA consent copy and legal review
- `[PM_FOLLOWUP]` Session timeout preference for Thai photographers
- `[ENG_DEBT]` Add structured logging with correlation IDs
- `[ENG_DEBT]` Dashboard component tests (no patterns exist yet)

---

## Research agenda (must complete before final.md)

| # | Topic | Question | Blocking | Output |
|---|-------|----------|----------|--------|
| R1 | HEIC/Rekognition | Does Rekognition accept HEIC directly, or need conversion? | Yes (US-7, US-8) | `research/heic-rekognition.md` |
| R2 | Cloudflare Images | Can CF Images generate thumbnails from R2 objects? How? | Yes (US-9) | `research/cf-images-thumbnails.md` |
| R3 | QR code generation | Best library for server-side QR PNG generation on Workers? | Yes (US-5) | `research/qr-code-library.md` |

---

## References
- ADRs: (pending decisions)
- Research: (pending)
- Upstream (PM): `product slice show --id d999677d-0b51-4b3b-b163-eec36a5bdde3`
- Context: `docs/logs/BS_0001_S-1/context/*.md`
