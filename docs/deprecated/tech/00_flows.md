# System Flows

**Status:** Draft
**Last Updated:** 2025-12-03

---

## Overview

This document describes the step-by-step flows for key operations. Each flow shows the sequence of actions across system components.

**Components:**

- **Client**: Web app, Desktop app, Lightroom plugin
- **API**: Hono on Cloudflare Workers
- **DB**: Postgres on Neon
- **R2**: Cloudflare R2 object storage
- **Rekognition**: AWS face detection/search
- **LINE**: LINE Messaging API
- **Clerk**: Authentication
- **Stripe**: Payments

---

## 1. Photographer Signup Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚  Clerk  â”‚     â”‚   API   â”‚     â”‚   DB    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚  1. Click "Sign in with LINE/Google/Email"    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  2. OAuth flow / OTP          â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  3. Return JWT + user info    â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  4. Call API with JWT         â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  5. Verify JWT with Clerk     â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  6. Check if photographer exists
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  7. If new: create photographer record
     â”‚               â”‚               â”‚  (status: pending_consent)
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  8. If new: add signup bonus credits
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  9. Return profile (status: pending_consent)  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  10. Frontend shows onboarding page           â”‚
     â”‚  "Before you start..."        â”‚               â”‚
     â”‚  - Checkbox (Thai + English): â”‚               â”‚
     â”‚    "I confirm I obtained consent from         â”‚
     â”‚     photographed individuals. [Privacy Policy]"
     â”‚               â”‚               â”‚               â”‚
     â”‚  11. User checks box, clicks "Complete Setup" â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  12. POST /api/photographers/me/complete-onboarding
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  13. Insert consent_record
     â”‚               â”‚               â”‚  (user_type: photographer,
     â”‚               â”‚               â”‚   consent_type: photographer_registration)
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  14. Update photographer
     â”‚               â”‚               â”‚  (status: active)
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  15. Return success, redirect to dashboard    â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
```

**PDPA Compliance:**

- Photographer must consent before accessing dashboard
- Consent stored with timestamp, IP address, privacy policy version
- Privacy Policy explains photographer's obligation to obtain consent from event participants

**Notes:**

- Clerk handles all OAuth/OTP complexity
- We sync profile data (name, avatar) from Clerk on each login
- Signup bonus credits added on first login (if configured)
- Dashboard access blocked until onboarding complete (status: active)

---

## 2. Credit Purchase Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚   API   â”‚     â”‚ Stripe  â”‚     â”‚   DB    â”‚     â”‚ Webhook â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  1. Select package (e.g., STARTER 500 credits)â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. Create Stripe Checkout Session             â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. Return checkout URL       â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  4. Redirect to Stripe Checkout               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  5. User completes payment    â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  6. Webhook: payment_intent.succeeded
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚  7. Create payment record
     â”‚               â”‚               â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚  8. Add credit ledger entry
     â”‚               â”‚               â”‚               â”‚  (type=purchase, expires_at=+6mo)
     â”‚               â”‚               â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  9. Redirect to success page  â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
```

**Notes:**

- Credits only added after Stripe webhook confirms payment
- Webhook handler is idempotent (checks for existing payment)
- `expires_at` set to 6 months from purchase

---

## 3. Create & Publish Event Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚   API   â”‚     â”‚   DB    â”‚     â”‚  Rekog  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚  1. Create event (name, dates)â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. Validate dates            â”‚
     â”‚               â”‚  (end > start, start not past)â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. Insert event (status=draft)
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  4. Return event              â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  ... configure settings ...   â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  5. Publish event             â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  6. Create Rekognition collection
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  7. Update event              â”‚
     â”‚               â”‚  (status=published, collection_id)
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  8. Return published event    â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
```

**Notes:**

- Rekognition collection created on publish, not on create
- Collection naming: `facelink-{event_uuid}`
- Draft events have no collection (saves cost)

---

## 4. Photo Upload Flow (Web/Desktop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚   API   â”‚     â”‚  D.O.  â”‚     â”‚   DB    â”‚     â”‚   R2    â”‚     â”‚  Rekog  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  1. Upload photo              â”‚               â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. CHECK RATE LIMIT          â”‚               â”‚               â”‚
     â”‚               â”‚  (per-user, Durable Object)   â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  If exceeded â†’ 429            â”‚               â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. VALIDATE                  â”‚               â”‚               â”‚
     â”‚               â”‚  - event.status = published   â”‚               â”‚               â”‚
     â”‚               â”‚  - now >= start_datetime      â”‚               â”‚               â”‚
     â”‚               â”‚  - now <= end_datetime        â”‚               â”‚               â”‚
     â”‚               â”‚  - credit_balance >= 1        â”‚               â”‚               â”‚
     â”‚               â”‚  - valid image type/size      â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  4. Deduct 1 credit (FIFO)    â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  5. Generate R2 key           â”‚               â”‚               â”‚
     â”‚               â”‚  6. Upload to R2              â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  7. Insert photo (status=pending)             â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  8. Write audit log (deliveries)              â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  9. Return photo (pending)    â”‚               â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  10. ASYNC: Process photo (queue)             â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  11. Update status=processing â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  12. IndexFaces (detects + indexes faces)     â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  13. Insert face records      â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  14. Update photo             â”‚               â”‚               â”‚
     â”‚               â”‚  (status=ready, face_count)   â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  15. Update event stats       â”‚               â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  16. WebSocket: photo ready   â”‚               â”‚               â”‚               â”‚
     â”‚      â†’ See 06_websocket.md for pattern                                       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
```

**Key validation order:**

1. **Rate limit check** (Durable Object) â†’ `RATE_LIMITED` (429)
2. Event published? â†’ `EVENT_NOT_PUBLISHED`
3. Upload window open? â†’ `EVENT_NOT_STARTED` or `EVENT_UPLOAD_CLOSED`
4. Has credits? â†’ `INSUFFICIENT_CREDITS`
5. Valid file? â†’ `INVALID_FILE_TYPE` or `FILE_TOO_LARGE`

**Important sequencing:**

- **Rate limit checked FIRST** - fast check (<1ms), prevents wasted work
- **Credit deduction happens BEFORE R2 upload** - ensures atomicity
- **Audit log written AFTER upload** - permanent business record (Neon Postgres)

---

## 5. FTP Upload Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Camera  â”‚     â”‚FTP (VPS)â”‚     â”‚   API   â”‚     â”‚ ...rest â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚  1. FTP connect (credentials) â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. Validate credentials      â”‚
     â”‚               â”‚  (photographer_id + event_id) â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  3. FTP login success         â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  4. Upload file via FTP       â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  5. Forward to API            â”‚
     â”‚               â”‚  (same as web upload)         â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  ... same as flow 4 ...
     â”‚               â”‚               â”‚               â”‚
```

**FTP credentials format:**

- Username: `{photographer_id}_{event_id}`
- Password: Generated token per event

**FTP server role:** Thin proxy that forwards to API. No local storage.

---

## 6. Face Search Flow (Web - Anonymous)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚CF WAF   â”‚     â”‚   API   â”‚     â”‚   DB    â”‚     â”‚  Rekog  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  1. Submit selfie for event   â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. CHECK RATE LIMIT          â”‚               â”‚
     â”‚               â”‚  (per-IP: 600/min, Cloudflare WAF)            â”‚
     â”‚               â”‚  (global: 1800/min, Cloudflare WAF)           â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  If exceeded â†’ 429            â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. Forward to API            â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  4. VALIDATE                  â”‚
     â”‚               â”‚               â”‚  - event exists & published   â”‚
     â”‚               â”‚               â”‚  - event not expired          â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  5. CHECK CONSENT             â”‚
     â”‚               â”‚               â”‚  If logged in: check existing consent
     â”‚               â”‚               â”‚  If anonymous: always require consent
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  6. If no consent: show dialog                â”‚               â”‚
     â”‚  Checkbox (Thai + English):   â”‚               â”‚               â”‚
     â”‚  "I consent to facial recognition processing. â”‚               â”‚
     â”‚   [Privacy Policy]"           â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  7. User checks box, submits  â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  8. Insert consent_record     â”‚
     â”‚               â”‚               â”‚  (user_id: NULL for anonymous,
     â”‚               â”‚               â”‚   search_session_id: TBD)
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  9. Check cache (event_id + face_hash)
     â”‚               â”‚               â”‚  If cached: return cached results
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  10. Store selfie temporarily â”‚
     â”‚               â”‚               â”‚  (R2 temp prefix, 1 hour TTL) â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  11. SearchFacesByImage       â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  12. Get matching face_ids + similarity
     â”‚               â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  13. Lookup photos by face_idsâ”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  14. Create search_session    â”‚
     â”‚               â”‚               â”‚  (participant_id = NULL for anon)
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  15. Create search_results    â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  16. Cache results            â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  17. Return matching photos   â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
```

**Key validation order:**

1. **Rate limit check** (Cloudflare WAF) â†’ `RATE_LIMITED` (429)
   - 600 requests/min per IP
   - 1800 requests/min global
2. Event exists & published? â†’ `EVENT_NOT_FOUND` or `EVENT_NOT_PUBLISHED`
3. Event not expired? â†’ `EVENT_EXPIRED`
4. **Consent given?** â†’ Show consent dialog if not

**PDPA Compliance:**

- Anonymous users: Always show consent (can't track between sessions)
- Logged-in users: Check if consent already given for this event, only ask once
- Consent stored with search_session_id (for anonymous) or participant_id (for logged-in)
- Privacy Policy explains: facial recognition, cross-border transfer (USA), 1-month retention

**Notes:**

- No login required for web search
- Rate limiting via Cloudflare WAF (per-IP + global)
- Cache key: hash of (event_id + selfie_face_embedding)
- Cache TTL: Event lifetime (1 month from start) - persists until event expires
- `participant_id` is NULL for anonymous searches
- Selfie stored temporarily in R2 with 1 hour auto-delete

---

## 7. Photo Download Flow (Web - Anonymous)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚     â”‚   API   â”‚     â”‚   DB    â”‚     â”‚ R2/CDN  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚  1. Request download (photo_ids)              â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. Validate event not expiredâ”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. Get photo R2 keys         â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  4. Generate signed URLs      â”‚
     â”‚               â”‚  (or direct CDN URLs)         â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  5. Return download URLs      â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  6. Download from CDN         â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚
     â”‚  7. Photos    â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚               â”‚               â”‚               â”‚
```

**Notes:**

- No login required
- Photos served via Cloudflare CDN
- For multiple photos: return individual URLs or generate ZIP

---

## 8. LINE Notification Flow (Web - "Send to LINE" Button)

â†’ See `06_line_messaging.md` for integration pattern

**VERIFIED:** Based on competitor (Pixid) implementation - this is the standard Thai market flow.

**Two requirements for sending photos via LINE:**

1. User must sign in with LINE (we get `userId`)
2. User must be friend of our OA (otherwise message silently fails)

### 8a. New User Flow (Not signed in, not friend)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PARTICIPANT WEB APP (after face search, viewing results)              â”‚
â”‚                                                                         â”‚
â”‚  [Download Photos]     [à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸œà¹ˆà¸²à¸™ Line / Send via LINE]               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ User clicks "Send via LINE"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: LINE Login Screen (access.line.me)                            â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  LINE                                   â”‚                           â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚
â”‚  â”‚  facelink-login                         â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚  à¸ªà¸´à¸—à¸˜à¸´à¹Œà¸à¸²à¸£à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸—à¸µà¹ˆà¸£à¹‰à¸­à¸‡à¸‚à¸­:              â”‚                           â”‚
â”‚  â”‚  â˜‘ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹‚à¸›à¸£à¹„à¸Ÿà¸¥à¹Œ (à¸•à¹‰à¸­à¸‡à¸à¸²à¸£)              â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚  à¸ªà¸³à¸«à¸£à¸±à¸šà¸œà¸¹à¹‰à¹ƒà¸Šà¹‰ (à¸•à¹‰à¸­à¸‡à¸à¸²à¸£):                 â”‚                           â”‚
â”‚  â”‚  â˜ facelink  [Add friend checkbox]      â”‚  â† bot_prompt=aggressive  â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚         [à¸­à¸™à¸¸à¸à¸²à¸• / Allow]                â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ User allows + checks "Add friend"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 5: Add Friend Screen (if not already friend)                     â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  LINE                                   â”‚                           â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚
â”‚  â”‚  â˜‘ facelink                             â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚  [à¹€à¸žà¸´à¹ˆà¸¡à¹€à¸žà¸·à¹ˆà¸­à¸™ / Add Friend]              â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚         [à¸à¸¥à¸±à¸š / Back]                   â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼ Redirect back to our app
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 6-7: Back on our app                                             â”‚
â”‚                                                                         â”‚
â”‚  â˜‘ Select photos                                                       â”‚
â”‚  [à¸ªà¹ˆà¸‡à¸£à¸¹à¸›à¸œà¹ˆà¸²à¸™ Line] â† Click again                                        â”‚
â”‚                                                                         â”‚
â”‚  âœ“ à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ / Sent successfully!                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 8: Photos arrive in LINE chat                                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚  facelink                               â”‚                           â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚  [Photo carousel / Flex message]        â”‚                           â”‚
â”‚  â”‚  ðŸ–¼ï¸ ðŸ–¼ï¸ ðŸ–¼ï¸                               â”‚                           â”‚
â”‚  â”‚                                         â”‚                           â”‚
â”‚  â”‚  [Link to gallery]                      â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8b. Technical Flow (Sequence Diagram)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web App â”‚     â”‚LINE Authâ”‚     â”‚   API   â”‚     â”‚  D.O.  â”‚     â”‚   DB    â”‚     â”‚LINE Msg â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  1. Click "Send via LINE"     â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  2. Check: logged in + friend?â”‚               â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  3a. If YES: skip to step 10  â”‚               â”‚               â”‚               â”‚
     â”‚  3b. If NO: redirect to LINE Login            â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  4. LINE Login + bot_prompt=aggressive        â”‚               â”‚               â”‚
     â”‚  (consent screen with "Add friend" option)    â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  5. User approves + adds friend               â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  6. Redirect back with auth code              â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  7. Exchange code for token + get userId      â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  8. Create/update participant â”‚               â”‚
     â”‚               â”‚               â”‚  (line_user_id, line_linked=true)             â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  9. Request: send photos to LINE              â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  10. CHECK RATE LIMIT         â”‚               â”‚
     â”‚               â”‚               â”‚  (per-user: 10/min, Durable Object)           â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  If exceeded â†’ 429            â”‚               â”‚
     â”‚               â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  11. Verify line_linked=true  â”‚               â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  12. Build Flex Message       â”‚               â”‚
     â”‚               â”‚               â”‚  (image carousel, max 12)     â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  13. Push message via API     â”‚               â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚  14. Log notification         â”‚               â”‚
     â”‚               â”‚               â”‚  (photographer_id, photo_count, ip_address)   â”‚
     â”‚               â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  15. "à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!" (Sent!)     â”‚               â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚               â”‚
```

**Key validation order:**

1. **User authentication check** - must be logged in with LINE
2. **Friendship check** - must be friend of OA (`line_linked=true`)
3. **Rate limit check** (Durable Object, per-user) â†’ `RATE_LIMITED` (429)
   - 10 requests/min per user
4. Verify `line_linked=true` â†’ `LINE_NOT_LINKED` (422)

### 8c. Returning User Flow (Already signed in + friend)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Web App â”‚     â”‚   API   â”‚     â”‚  D.O.  â”‚     â”‚   DB    â”‚     â”‚LINE Msg â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  1. Click "Send via LINE"     â”‚               â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  2. CHECK RATE LIMIT          â”‚               â”‚
     â”‚               â”‚  (per-user: 10/min, Durable Object)           â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  If exceeded â†’ 429            â”‚               â”‚
     â”‚               â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  3. Check participant         â”‚               â”‚
     â”‚               â”‚  (line_linked=true? âœ“)        â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  4. Build + send immediately  â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚  5. Log notification          â”‚               â”‚
     â”‚               â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
     â”‚  6. "à¸ªà¹ˆà¸‡à¸ªà¸³à¹€à¸£à¹‡à¸ˆ!"               â”‚               â”‚               â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚               â”‚
```

**Key points:**

- LINE Login uses `bot_prompt=aggressive` to show separate "Add friend" screen after consent
- If user doesn't add friend, we store `line_linked=false` and prompt again next time
- Silent failure if we try to send to non-friend (API returns 200 but no delivery)
- Always check `line_linked=true` before attempting push message

**LINE Login URL parameters:**

```
https://access.line.me/oauth2/v2.1/authorize?
  response_type=code
  &client_id={CHANNEL_ID}
  &redirect_uri={CALLBACK_URL}
  &state={STATE}
  &scope=profile
  &bot_prompt=aggressive
```

---

## 9. Event Expiry Flow (Cron)

**(Previously flow 10 - LIFF flow removed)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron   â”‚     â”‚   DB    â”‚     â”‚   R2    â”‚     â”‚  Rekog  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚               â”‚
     â”‚  1. Run daily at 00:00 BKK    â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  2. Query expired events      â”‚               â”‚
     â”‚  WHERE start_datetime + 1 month < NOW()       â”‚
     â”‚  AND NOT already_expired      â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  3. For each expired event:   â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    4. Delete Rekognition collection           â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
     â”‚               â”‚               â”‚               â”‚
     â”‚    5. List R2 objects for event               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    6. Delete R2 objects       â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    7. Delete face records     â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    8. Delete search_results   â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    9. Delete search_sessions  â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚    10. Mark event as expired  â”‚               â”‚
     â”‚    (keep record, clear data)  â”‚               â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚               â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
     â”‚  11. Log completion           â”‚               â”‚
     â”‚               â”‚               â”‚               â”‚
```

**Notes:**

- Run via Cloudflare Workers Cron Trigger
- Process in batches to avoid timeout
- Event record preserved (for history/accounting)

---

## 10. Credit Expiry Flow (Cron)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron   â”‚     â”‚   DB    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚
     â”‚  1. Run daily at 00:00 BKK
     â”‚               â”‚
     â”‚  2. Find expiring credit batches
     â”‚  WHERE expires_at <= NOW()
     â”‚  AND type IN ('purchase', 'bonus', 'promo')
     â”‚  AND NOT already_expired
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚
     â”‚  3. For each expiring batch:
     â”‚               â”‚
     â”‚    4. Calculate remaining from this batch
     â”‚    (using FIFO consumption tracking)
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚
     â”‚    5. If remaining > 0:
     â”‚       Insert ledger entry
     â”‚       (type='expired', amount=-remaining)
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚
     â”‚    6. Mark batch as expired
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚               â”‚
     â”‚  7. Send low-balance alerts if needed
     â”‚               â”‚
```

**FIFO tracking:**

- Each credit batch has ID and `expires_at`
- When consuming, track which batch credits came from
- On expiry, only expire unused portion of that batch

---

## Flow Summary

| #   | Flow                   | Trigger       | Key Components                          |
| --- | ---------------------- | ------------- | --------------------------------------- |
| 1   | Photographer Signup    | User action   | Clerk â†’ API â†’ DB                        |
| 2   | Credit Purchase        | User action   | Stripe â†’ Webhook â†’ DB                   |
| 3   | Create & Publish Event | User action   | API â†’ DB â†’ Rekognition                  |
| 4   | Photo Upload (Web)     | User action   | API â†’ DB â†’ R2 â†’ Rekognition             |
| 5   | Photo Upload (FTP)     | Camera upload | FTP â†’ API â†’ ...                         |
| 6   | Face Search (Web)      | User action   | API â†’ Rekognition â†’ DB                  |
| 7   | Photo Download         | User action   | API â†’ CDN                               |
| 8   | LINE Notification      | User action   | Clerk LINE Login â†’ API â†’ LINE Messaging |
| 9   | Event Expiry           | Cron (daily)  | Cron â†’ DB â†’ R2 â†’ Rekognition            |
| 10  | Credit Expiry          | Cron (daily)  | Cron â†’ DB                               |

**Note:** LIFF flow removed from MVP to reduce complexity. All participant auth goes through Clerk.
